<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <title>NYC Subway</title>
  <link rel="stylesheet" href="/app/styles/index.css">
  <link href="css/bootstrap.min.css" rel="stylesheet">
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>

</head>

<body>
  <div id="coords">
    Loading...
  </div>
  <div id="station">
  </div>
  
 <script>
    var x = document.getElementById("coords");
    var current;    
    $(document).ready(function(){
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(showPosition);
        } 
        else {
            x.innerHTML = "Geolocation is not supported by this browser.";
        }
    });      
    function showPosition(position) {
        current = position;
        x.innerHTML = "Latitude: " + position.coords.latitude + 
        "<br>Longitude: " + position.coords.longitude; 
        findStation(current);
    }

    function findStation(pos){
      var distance = []       
      $.ajax({
          type : "GET",
          url : "/getcsvjson/stops",
          success : function(data){
            for(var i = 0;i<data.length;i++)
            {
              distance.push(
                    getDistance(pos.coords.latitude, pos.coords.longitude, data[i].stop_lat, data[i].stop_lon)
                  );
            }
            var result = findMaxVals(distance);
            console.log(result[0]);
            $('#station').text("Closest Stop: " + data[result[0].stop].stop_name);
          }
        });
      
    }

    function findMaxVals(arr){
      var output = [];
      var result = Math.min.apply(Math,arr);
      output[0] = {stop: arr.indexOf(result), dist : result};
      return output;
    }

    //takes in two sets of points and returns distance
    function getDistance(lat1, lon1, lat2, lon2){
      var R = 6371; // km
      var φ1 = toRad(lat1);
      var φ2 = toRad(lat2);
      var Δφ = toRad(lat2-lat1);
      var Δλ = toRad(lat2-lat1);

      var a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
              Math.cos(φ1) * Math.cos(φ2) *
              Math.sin(Δλ/2) * Math.sin(Δλ/2);
      var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

      var d = R * c;
      return d;
    }

    /** Converts numeric degrees to radians */
    function toRad(Value) {
      return Value * Math.PI / 180;
    }   

  </script>
</body>
</html>
